<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mi Reloj</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon.png" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    :root {
      --primary-color: #6a11cb; /* Morado */
      --secondary-color: #2575fc; /* Azul */
      --accent-color: #ffda44; /* Amarillo vibrante */
      --background-light: #f0f2f5; /* Gris claro */
      --text-dark: #333;
      --text-light: #fff;
      --green-status: #4CAF50;
      --red-status: #f44336;
    }

    body {
      font-family: 'Roboto', sans-serif;
      text-align: center;
      padding: 2em;
      background: linear-gradient(to right, var(--background-light), #e0e6ed);
      color: var(--text-dark);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .container {
      background: var(--text-light);
      padding: 2em;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      max-width: 90%;
      width: 500px;
      box-sizing: border-box;
    }

    h1 {
      font-size: 5em;
      margin: 0.2em 0;
      color: var(--primary-color);
      letter-spacing: -2px;
      font-weight: 700;
    }

    #modo, #acumulados {
      font-size: 1.3em;
      margin: 0.8em 0;
      font-weight: 400;
    }

    #acumulados {
      color: #666;
    }

    #pinForm {
      margin-top: 1.5em;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #pinInput {
      padding: 0.8em;
      margin-bottom: 1em;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1.1em;
      text-align: center;
      width: 80%;
      max-width: 250px;
    }

    button {
      font-size: 1.1em;
      padding: 0.8em 1.5em;
      margin: 0.4em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text-light);
      font-weight: 700;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    button[onclick="verificarPIN()"] { background: var(--secondary-color); }
    button[onclick="verificarPIN()"]:hover { background: #1e67e2; }

    button[onclick="iniciarDesdeCero()"] { background: var(--green-status); }
    button[onclick="iniciarDesdeCero()"]:hover { background: #409b44; }

    button[onclick="cambiarModo()"] { background: var(--primary-color); }
    button[onclick="cambiarModo()"]:hover { background: #5a0ebf; }

    button[onclick="alternarActivo()"] { background: #ff9800; } /* Naranja para Pausar/Reanudar */
    button[onclick="alternarActivo()"]:hover { background: #e68900; }

    button[onclick="generarReporte()"] { background: #03a9f4; } /* Azul claro para Reporte */
    button[onclick="generarReporte()"]:hover { background: #0288d1; }

    #controles {
      margin-top: 1.5em;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px; /* Espacio entre botones */
    }

    #reporte-semanal {
      margin-top: 3em;
      padding: 1.5em;
      background: #f0f8ff; /* Fondo muy claro para el reporte */
      border-radius: 10px;
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
      text-align: left;
      font-size: 0.95em;
      max-width: 90%;
      width: 500px;
      box-sizing: border-box;
    }

    #reporte-semanal h2 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 1em;
      font-size: 1.6em;
      font-weight: 700;
    }

    .reporte-dia {
      display: flex;
      justify-content: space-between;
      padding: 0.6em 0;
      border-bottom: 1px dashed #e0e0e0;
    }
    .reporte-dia:last-child {
      border-bottom: none;
    }
    .reporte-dia span {
      flex: 1;
      padding: 0 5px;
    }
    .reporte-dia .tiempo {
      text-align: right;
      font-weight: bold;
    }

    /* Iconos de estado para acumulados */
    .icon-green { color: var(--green-status); }
    .icon-red { color: var(--red-status); }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="tiempo">00:00:00</h1>
    <div id="modo">Modo: ‚è± Juego sin pantalla</div>
    <div id="acumulados"></div>

    <div id="pinForm">
      <input type="password" id="pinInput" placeholder="PIN">
      <button onclick="verificarPIN()">üîì Desbloquear</button>
    </div>

    <div id="controles">
      <button onclick="iniciarDesdeCero()">üöÄ Iniciar / Restablecer</button>
      <button onclick="cambiarModo()">‚ÜîÔ∏è Cambiar Modo</button>
      <button onclick="alternarActivo()">‚è∏Ô∏è Pausar / ‚ñ∂Ô∏è Reanudar</button>
      <button onclick="generarReporte()">üìä Ver Reporte Semanal</button> </div>
  </div>

  <div id="reporte-semanal" style="display: none;">
    <h2>Reporte de Uso (√öltimos 7 D√≠as)</h2>
    <div id="reporte-contenido">
      Cargando reporte...
    </div>
  </div>

  <audio id="alarma" src="beep.mp3" preload="auto"></audio>

<script>
  const PIN = "1901";

  const firebaseConfig = {
    apiKey: "AIzaSyBcla-wEjFVTBZolxttysM_N8q_fYuLSAE",
    authDomain: "reloj-e5ff7.firebaseapp.com",
    databaseURL: "https://reloj-e5ff7-default-rtdb.firebaseio.com",
    projectId: "reloj-e5ff7",
    storageBucket: "reloj-e5ff7.firebasestorage.app",
    messagingSenderId: "694363221214",
    appId: "1:694363221214:web:dad4c89caff0b1d550264f"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const ref = db.ref("reloj"); // Nodo principal para el estado del reloj

  function formatear(s) {
    if (s < 0) s = 0; // Asegurarse de que el tiempo no sea negativo
    const h = String(Math.floor(s / 3600)).padStart(2, '0');
    const m = String(Math.floor((s % 3600) / 60)).padStart(2, '0');
    const sec = String(s % 60).padStart(2, '0');
    return `${h}:${m}:${sec}`;
  }

  function verificarPIN() {
    const ingresado = document.getElementById("pinInput").value;
    if (ingresado === PIN) {
      document.getElementById("controles").style.display = "flex"; // Usar flex para los botones
      document.getElementById("pinForm").style.display = "none";
    } else {
      alert("PIN incorrecto");
    }
  }

  function iniciarDesdeCero() {
    ref.set({
      valorVisible: 0,
      modo: 1, // Inicia en modo "Juego sin pantalla"
      activo: true, // Inicia activo
      // Contadores diarios
      tiempoJuegoHoy: 0,
      tiempoPantallaHoy: 0,
      ultimaFechaRegistro: new Date().toISOString().slice(0, 10) // Fecha de hoy
    });
    // Ocultar reporte si est√° visible al reiniciar
    document.getElementById("reporte-semanal").style.display = "none";
  }

  function cambiarModo() {
    ref.get().then(snap => {
      const data = snap.val();
      if (!data) return;
      const nuevoModo = data.modo * -1;
      ref.update({ modo: nuevoModo });
    });
  }

  function alternarActivo() {
    ref.get().then(snap => {
      const data = snap.val();
      if (!data) return;
      const nuevoActivo = !data.activo;
      ref.update({ activo: nuevoActivo });
    });
  }

  // --- L√≥gica de Actualizaci√≥n y Registro Diario ---
  setInterval(() => {
    ref.get().then(snap => {
      const data = snap.val();
      if (!data || !data.activo) return; // Si no hay datos o 'activo' es false, no actualizamos

      // Actualizar valorVisible
      let nuevoValor = data.valorVisible + data.modo;
      if (nuevoValor < 0) {
        nuevoValor = 0;
        document.getElementById("alarma").play();
      }

      // Actualizar contadores diarios (tiempoJuegoHoy, tiempoPantallaHoy)
      let tiempoJuegoHoy = data.tiempoJuegoHoy || 0;
      let tiempoPantallaHoy = data.tiempoPantallaHoy || 0;

      if (data.modo === 1) { // Modo Juego sin pantalla
        tiempoJuegoHoy++;
      } else { // Modo Uso de pantalla
        tiempoPantallaHoy++;
      }

      ref.update({
        valorVisible: nuevoValor,
        tiempoJuegoHoy: tiempoJuegoHoy,
        tiempoPantallaHoy: tiempoPantallaHoy
      });
    });
  }, 1000); // Se ejecuta cada segundo

  // --- L√≥gica para guardar datos diarios y actualizar UI ---
  ref.on("value", snap => {
    const data = snap.val();
    if (!data) {
      // Si no hay datos iniciales, mostramos valores por defecto
      document.getElementById("tiempo").textContent = "00:00:00";
      document.getElementById("modo").textContent = "Modo: ‚è± Juego sin pantalla";
      document.getElementById("acumulados").textContent = "üü¢ Juego Hoy: 00:00:00 | üî¥ Pantalla Hoy: 00:00:00";
      return;
    }

    const hoy = new Date();
    const fechaHoy = hoy.toISOString().slice(0, 10); // Formato "YYYY-MM-DD"

    // Comprobar si el d√≠a ha cambiado
    if (data.ultimaFechaRegistro && fechaHoy !== data.ultimaFechaRegistro) {
      const fechaAnterior = data.ultimaFechaRegistro;
      const tiempoJuegoGuardar = data.tiempoJuegoHoy || 0;
      const tiempoPantallaGuardar = data.tiempoPantallaHoy || 0;

      // Guardar los datos del d√≠a anterior en registrosDiarios
      db.ref(`reloj/registrosDiarios/${fechaAnterior}`).set({
        juegoSinPantalla: tiempoJuegoGuardar,
        usoDePantalla: tiempoPantallaGuardar
      }).then(() => {
        console.log(`Registros diarios guardados para ${fechaAnterior}`);
        // Reiniciar contadores diarios y actualizar la fecha de registro para el nuevo d√≠a
        ref.update({
          tiempoJuegoHoy: 0,
          tiempoPantallaHoy: 0,
          ultimaFechaRegistro: fechaHoy
        });
      }).catch(error => {
        console.error("Error al guardar registros diarios:", error);
      });
    } else if (!data.ultimaFechaRegistro) {
        // Inicializar ultimaFechaRegistro si no existe
        ref.update({ ultimaFechaRegistro: fechaHoy });
    }

    // Actualizar la interfaz de usuario principal
    document.getElementById("tiempo").textContent = formatear(data.valorVisible);
    document.getElementById("modo").textContent = data.modo === 1 ? "Modo: ‚è± Juego sin pantalla" : "Modo: üì± Uso de pantalla";
    const estadoActivo = data.activo ? "Activo" : "Pausado";
    document.getElementById("acumulados").innerHTML =
      `üü¢ Juego Hoy: ${formatear(data.tiempoJuegoHoy || 0)} | üî¥ Pantalla Hoy: ${formatear(data.tiempoPantallaHoy || 0)} <br> Estado: ${estadoActivo}`;
  });

  // --- L√≥gica del Reporte Semanal ---
  function generarReporte() {
    const reporteDiv = document.getElementById("reporte-semanal");
    const reporteContenido = document.getElementById("reporte-contenido");
    reporteContenido.innerHTML = "Cargando reporte...";
    reporteDiv.style.display = "block"; // Mostrar el div del reporte

    const hoy = new Date();
    const fechas = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(hoy);
      d.setDate(hoy.getDate() - i);
      fechas.push(d.toISOString().slice(0, 10)); // "YYYY-MM-DD"
    }
    fechas.reverse(); // Para que el reporte muestre del d√≠a m√°s antiguo al m√°s reciente

    const promesasReporte = fechas.map(fecha => {
      return db.ref(`reloj/registrosDiarios/${fecha}`).get().then(snap => {
        const data = snap.val();
        return {
          fecha: fecha,
          juegoSinPantalla: data ? (data.juegoSinPantalla || 0) : 0,
          usoDePantalla: data ? (data.usoDePantalla || 0) : 0
        };
      }).catch(error => {
        console.error(`Error al obtener datos para ${fecha}:`, error);
        return { fecha: fecha, juegoSinPantalla: 0, usoDePantalla: 0 }; // Devuelve cero si hay error
      });
    });

    Promise.all(promesasReporte).then(resultados => {
      let htmlReporte = '';
      resultados.forEach(dia => {
        const fechaFormateada = new Date(dia.fecha + 'T00:00:00').toLocaleDateString('es-AR', {
          weekday: 'short', month: 'numeric', day: 'numeric'
        });
        htmlReporte += `
          <div class="reporte-dia">
            <span>${fechaFormateada}</span>
            <span>üü¢ ${formatear(dia.juegoSinPantalla)}</span>
            <span>üî¥ ${formatear(dia.usoDePantalla)}</span>
          </div>
        `;
      });
      reporteContenido.innerHTML = htmlReporte;
    }).catch(error => {
      console.error("Error al generar el reporte completo:", error);
      reporteContenido.innerHTML = "No se pudo cargar el reporte.";
    });
  }

  // --- Registro del Service Worker ---
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('Service Worker registrado con √©xito:', reg))
      .catch(err => console.error('Error al registrar el Service Worker:', err));
  }
</script>
</body>
</html>
