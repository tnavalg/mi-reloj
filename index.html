<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mi Reloj</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon.png" />
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
  <h1 id="tiempo">00:00:00</h1>
  <div id="modo">Modo: ‚è± Juego sin pantalla</div>
  <div id="acumulados"></div>

  <div id="pinForm">
    <input type="password" id="pinInput" placeholder="PIN">
    <button onclick="verificarPIN()">üîì Desbloquear</button>
  </div>

  <div id="controles" style="display: none;">
    <button onclick="iniciarDesdeCero()">üöÄ Iniciar / Restablecer</button>
    <button onclick="cambiarModo()">‚ÜîÔ∏è Cambiar Modo</button>
    <button onclick="alternarActivo()">‚è∏Ô∏è Pausar / ‚ñ∂Ô∏è Reanudar</button>
    <button onclick="generarReporte()">üìä Ver Reporte Semanal</button>
  </div>

  <div id="reporte-semanal" style="display: none;">
    <h2>Reporte de Uso (√öltimos 7 D√≠as)</h2>
    <div id="reporte-contenido">Cargando reporte...</div>
  </div>

  <audio id="alarma" src="beep.mp3" preload="auto"></audio>

  <script>
    const PIN = "1901";
    const firebaseConfig = {
      apiKey: "AIzaSyBcla-wEjFVTBZolxttysM_N8q_fYuLSAE",
      authDomain: "reloj-e5ff7.firebaseapp.com",
      databaseURL: "https://reloj-e5ff7-default-rtdb.firebaseio.com",
      projectId: "reloj-e5ff7",
      storageBucket: "reloj-e5ff7.appspot.com",
      messagingSenderId: "694363221214",
      appId: "1:694363221214:web:dad4c89caff0b1d550264f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const ref = db.ref("reloj");

    function formatear(s) {
      if (s < 0) s = 0;
      const h = String(Math.floor(s / 3600)).padStart(2, '0');
      const m = String(Math.floor((s % 3600) / 60)).padStart(2, '0');
      const sec = String(s % 60).padStart(2, '0');
      return `${h}:${m}:${sec}`;
    }

    function verificarPIN() {
      const ingresado = document.getElementById("pinInput").value;
      if (ingresado === PIN) {
        document.getElementById("controles").style.display = "block";
        document.getElementById("pinForm").style.display = "none";
      } else {
        alert("PIN incorrecto");
      }
    }

    function iniciarDesdeCero() {
      ref.set({
        valorVisible: 0,
        modo: 1,
        activo: true,
        tiempoJuegoHoy: 0,
        tiempoPantallaHoy: 0,
        ultimaFechaRegistro: new Date().toISOString().slice(0, 10)
      });
      document.getElementById("reporte-semanal").style.display = "none";
    }

    function cambiarModo() {
      ref.get().then(snap => {
        const data = snap.val();
        if (data) {
          const nuevoModo = data.modo * -1;
          ref.update({ modo: nuevoModo });
        }
      });
    }

    function alternarActivo() {
      ref.get().then(snap => {
        const data = snap.val();
        if (data) {
          ref.update({ activo: !data.activo });
        }
      });
    }

    setInterval(() => {
      ref.get().then(snap => {
        const data = snap.val();
        if (!data || !data.activo) return;
        let nuevoValor = data.valorVisible + data.modo;
        if (nuevoValor < 0) {
          nuevoValor = 0;
          document.getElementById("alarma").play();
        }
        let tiempoJuegoHoy = data.tiempoJuegoHoy || 0;
        let tiempoPantallaHoy = data.tiempoPantallaHoy || 0;
        if (data.modo === 1) tiempoJuegoHoy++;
        else tiempoPantallaHoy++;
        ref.update({
          valorVisible: nuevoValor,
          tiempoJuegoHoy,
          tiempoPantallaHoy
        });
      });
    }, 1000);

    ref.on("value", snap => {
      const data = snap.val();
      if (!data) return;
      const hoy = new Date().toISOString().slice(0, 10);
      if (data.ultimaFechaRegistro && hoy !== data.ultimaFechaRegistro) {
        db.ref(`reloj/registrosDiarios/${data.ultimaFechaRegistro}`).set({
          juegoSinPantalla: data.tiempoJuegoHoy || 0,
          usoDePantalla: data.tiempoPantallaHoy || 0
        }).then(() => {
          ref.update({
            tiempoJuegoHoy: 0,
            tiempoPantallaHoy: 0,
            ultimaFechaRegistro: hoy
          });
        });
      } else if (!data.ultimaFechaRegistro) {
        ref.update({ ultimaFechaRegistro: hoy });
      }
      document.getElementById("tiempo").textContent = formatear(data.valorVisible);
      document.getElementById("modo").textContent = data.modo === 1 ? "Modo: ‚è± Juego sin pantalla" : "Modo: üì± Uso de pantalla";
      document.getElementById("acumulados").textContent =
        `üü¢ Juego Hoy: ${formatear(data.tiempoJuegoHoy || 0)} | üî¥ Pantalla Hoy: ${formatear(data.tiempoPantallaHoy || 0)}`;
    });

    function generarReporte() {
      const panel = document.getElementById("reporte-semanal");
      const contenido = document.getElementById("reporte-contenido");
      if (panel.style.display === "block") {
        panel.style.display = "none";
        return;
      }
      panel.style.display = "block";
      contenido.innerHTML = "Cargando reporte...";

      const hoy = new Date();
      const fechas = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(hoy);
        d.setDate(hoy.getDate() - i);
        fechas.push(d.toISOString().slice(0, 10));
      }
      fechas.reverse();

      const promesas = fechas.map(fecha => {
        return db.ref(`reloj/registrosDiarios/${fecha}`).get().then(snap => {
          const data = snap.val();
          return {
            fecha,
            juegoSinPantalla: data ? (data.juegoSinPantalla || 0) : 0,
            usoDePantalla: data ? (data.usoDePantalla || 0) : 0
          };
        });
      });

      Promise.all(promesas).then(resultados => {
        let html = "";
        resultados.forEach(dia => {
          const fecha = new Date(dia.fecha + 'T00:00:00').toLocaleDateString('es-AR', { weekday: 'short', month: 'numeric', day: 'numeric' });
          html += `<div class="reporte-dia"><span>${fecha}</span> <span>üü¢ ${formatear(dia.juegoSinPantalla)}</span> <span>üî¥ ${formatear(dia.usoDePantalla)}</span></div>`;
        });
        contenido.innerHTML = html;
      });
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>
</body>
</html>
