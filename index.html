<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mi Reloj</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon.png" />
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: 'Comic Sans MS', cursive; text-align: center; padding: 2em; background: #fceabb; }
    h1 { font-size: 4em; margin: 0.5em; }
    #modo, #acumulados { font-size: 1.2em; margin: 1em; }
    button { font-size: 1.2em; margin: 0.3em; padding: 0.5em 1em; }
    #controles { display: none; }
  </style>
</head>
<body>
  <h1 id="tiempo">00:00:00</h1>
  <div id="modo">Modo: ⏱ Juego sin pantalla</div>
  <div id="acumulados"></div>
  <div id="pinForm">
    <input type="password" id="pinInput" placeholder="PIN">
    <button onclick="verificarPIN()">🔓 Desbloquear</button>
  </div>
  <div id="controles">
    <button onclick="iniciarDesdeCero()">🚀 Iniciar / Restablecer</button>
    <button onclick="cambiarModo()">↔️ Cambiar Modo</button>
  </div>
  <audio id="alarma" src="beep.mp3" preload="auto"></audio>

<script>
  const PIN = "1901";

  const firebaseConfig = {
    apiKey: "AIzaSyBcla-wEjFVTBZolxttysM_N8q_fYuLSAE",
    authDomain: "reloj-e5ff7.firebaseapp.com",
    databaseURL: "https://reloj-e5ff7-default-rtdb.firebaseio.com",
    projectId: "reloj-e5ff7",
    storageBucket: "reloj-e5ff7.firebasestorage.app",
    messagingSenderId: "694363221214",
    appId: "1:694363221214:web:dad4c89caff0b1d550264f"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const ref = db.ref("reloj");

  function formatear(s) {
    const h = String(Math.floor(s / 3600)).padStart(2, '0');
    const m = String(Math.floor((s % 3600) / 60)).padStart(2, '0');
    const sec = String(s % 60).padStart(2, '0');
    return `${h}:${m}:${sec}`;
  }

  function verificarPIN() {
    const ingresado = document.getElementById("pinInput").value;
    if (ingresado === PIN) {
      document.getElementById("controles").style.display = "block";
      document.getElementById("pinForm").style.display = "none";
    } else {
      alert("PIN incorrecto");
    }
  }

  function iniciarDesdeCero() {
    ref.set({ 
      valorVisible: 0, 
      tiempoJuego: 0, 
      tiempoPantalla: 0,
      modo: 1,
      activo: true
    });
  }

  function cambiarModo() {
    ref.get().then(snap => {
      const data = snap.val();
      const nuevoModo = data.modo * -1;
      ref.update({ modo: nuevoModo });
    });
  }

  setInterval(() => {
    ref.get().then(snap => {
      const data = snap.val();
      if (!data || !data.activo) return;

      let nuevoValor = data.valorVisible + data.modo;
      if (nuevoValor < 0) {
        nuevoValor = 0;
        document.getElementById("alarma").play();
      }

      const tiempoJuego = data.modo === 1 ? data.tiempoJuego + 1 : data.tiempoJuego;
      const tiempoPantalla = data.modo === -1 ? data.tiempoPantalla + 1 : data.tiempoPantalla;

      ref.update({
        valorVisible: nuevoValor,
        tiempoJuego: tiempoJuego,
        tiempoPantalla: tiempoPantalla
      });
    });
  }, 1000);

  ref.on("value", snap => {
    const data = snap.val();
    if (!data) return;
    document.getElementById("tiempo").textContent = formatear(data.valorVisible);
    document.getElementById("modo").textContent = data.modo === 1 ? "Modo: ⏱ Juego sin pantalla" : "Modo: 📱 Uso de pantalla";
    document.getElementById("acumulados").textContent = 
      `🟢 Juego: ${formatear(data.tiempoJuego)} | 🔴 Pantalla: ${formatear(data.tiempoPantalla)}`;
  });

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
</body>
</html>